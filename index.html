<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Perchar | Ingreso de Ubicaciones</title>

  <style>
    :root{
      --bg:#EAF6F4; --card:#FFFFFF; --ink:#22303A; --muted:#5C6B76; --line:#D7E7E3;
      --accent:#2FC49B; --accent2:#1E8D71; --danger:#E35B5B; --shadow:0 10px 30px rgba(0,0,0,.08);
      --r:16px; --font: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:var(--font);background:var(--bg);color:var(--ink)}
    header{position:sticky;top:0;z-index:20;background:rgba(255,255,255,.75);backdrop-filter: blur(10px);border-bottom:1px solid var(--line)}
    .topbar{max-width:1100px;margin:0 auto;padding:14px 16px;display:flex;align-items:center;gap:12px}
    .brand{display:flex;align-items:center;gap:10px;font-weight:800}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 0 6px rgba(47,196,155,.18)}
    .pill{margin-left:auto;display:flex;align-items:center;gap:8px;background:#E7FBF5;border:1px solid rgba(47,196,155,.35);color:var(--accent2);padding:8px 12px;border-radius:999px;font-weight:700}
    main{max-width:1100px;margin:18px auto;padding:0 16px 28px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden}
    .card h2{margin:0;padding:14px 16px;font-size:16px;border-bottom:1px solid var(--line);display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap;background:linear-gradient(0deg, rgba(234,246,244,.35), rgba(234,246,244,.35))}
    .content{padding:14px 16px}

    .row{display:grid;grid-template-columns:1fr 1fr 1fr .6fr;gap:10px;align-items:end}
    @media (max-width: 900px){ .row{grid-template-columns:1fr 1fr} }

    label{display:block;font-size:12px;color:var(--muted);margin:0 0 6px}
    input{width:100%;padding:11px 12px;border:1px solid var(--line);border-radius:12px;outline:none;font-size:14px;background:#fff}
    input:focus{border-color:rgba(47,196,155,.65);box-shadow:0 0 0 4px rgba(47,196,155,.15)}

    .btnbar{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{border:0;padding:11px 14px;border-radius:12px;font-weight:800;cursor:pointer;transition:.15s transform,.15s opacity;user-select:none;white-space:nowrap}
    button:active{transform:translateY(1px)}
    .btn-primary{background:var(--accent);color:#083127}
    .btn-secondary{background:#F2FBF8;color:var(--accent2);border:1px solid rgba(47,196,155,.35)}
    .btn-danger{background:#FFECEC;color:#8A1E1E;border:1px solid rgba(227,91,91,.35)}
    .tag{display:inline-flex;align-items:center;gap:6px;font-size:12px;font-weight:700;padding:6px 10px;border-radius:999px;background:#F5FBFA;border:1px solid var(--line);color:var(--muted)}
    .status{font-size:12px;color:var(--muted);margin-left:10px;font-weight:800}
    .status.ok{color:var(--accent2)}
    .status.bad{color:#8A1E1E}

    /* TABLA DESKTOP */
    .twrap{max-height:520px;overflow:auto;border-top:1px solid var(--line)}
    table{width:100%;border-collapse:separate;border-spacing:0;font-size:13px;table-layout:fixed}
    thead th{text-align:left;padding:10px 12px;background:#E8F7F3;color:#0D3B30;border-bottom:1px solid var(--line);position:sticky;top:0;z-index:2;white-space:nowrap}
    tbody td{padding:10px 12px;border-bottom:1px solid #EEF5F3;color:var(--ink);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    tbody tr:hover td{background:#FBFEFD}
    .right{text-align:right}
    .btn-del{padding:9px 12px;border-radius:12px;font-weight:900;border:1px solid rgba(227,91,91,.35);background:#FFECEC;color:#8A1E1E;cursor:pointer;white-space:nowrap}

    /* PANEL OPERADOR (móvil) */
    .operator{display:none}
    .operator .grid{display:grid;grid-template-columns:1fr;gap:10px}
    .operator .big input{font-size:16px;padding:14px 14px;border-radius:14px}
    .operator .btnbar{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .operator .btnbar button{padding:14px 14px;border-radius:14px;font-size:15px}
    .operator .btnbar .span2{grid-column:1 / -1}

    /* Toggle teclado (NUM / ABC) */
    .keyRow{display:flex; gap:10px; align-items:center}
    .keyRow .keyWrap{flex:1}
    .keyBtn{
      padding:12px 12px;
      border-radius:12px;
      font-weight:900;
      background:#F2FBF8;
      color:var(--accent2);
      border:1px solid rgba(47,196,155,.35);
      cursor:pointer;
      min-width:88px;
    }
    .keyBtn.active{
      background:var(--accent);
      color:#083127;
      border-color:transparent;
    }

    /* LISTA MÓVIL */
    .mobileList{display:none}
    .mItem{border-top:1px solid var(--line);padding:12px 14px;display:grid;gap:8px}
    .mTop{display:flex;align-items:center;justify-content:space-between;gap:10px;font-weight:900}
    .mMeta{display:grid;grid-template-columns:1fr 1fr;gap:8px;color:var(--muted);font-size:12px;font-weight:800}
    .mMeta div{background:#F5FBFA;border:1px solid var(--line);border-radius:12px;padding:8px 10px}
    .mActions{display:flex;justify-content:flex-end}

    @media (max-width:560px){
      main{padding:0 12px 22px}
      .content{padding:12px}
      .desktopPanel{display:none}
      .operator{display:block}
      .twrap{display:none}
      .mobileList{display:block}
    }
  </style>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>
  <header>
    <div class="topbar">
      <div class="brand"><span class="dot"></span> Perchar</div>
      <div class="pill">Data</div>
    </div>
  </header>

  <main>
    <datalist id="locList"></datalist>

    <section class="card">
      <h2>
        Panel | Ingreso de movimientos
        <span>
          <span class="tag" id="countTag">0 registros</span>
          <span class="status" id="syncStatus">Sincronizando…</span>
        </span>
      </h2>

      <!-- DESKTOP -->
      <div class="content desktopPanel">
        <div class="row">
          <div>
            <label for="codigo">Código</label>
            <input id="codigo" placeholder="Ej: 12760 o TODO"
              autocomplete="off" type="text" inputmode="numeric" pattern="[0-9]*" />
          </div>

          <div>
            <label for="posFrom">Posición (From)</label>
            <input id="posFrom" list="locList" placeholder="Ej: 01-30-088-02"
              autocomplete="off" type="text" inputmode="numeric" pattern="[0-9]*" />
          </div>

          <div>
            <label for="posTo">Posición (To)</label>
            <input id="posTo" list="locList" placeholder="Ej: 01-30-088-03"
              autocomplete="off" type="text" inputmode="numeric" pattern="[0-9]*" />
          </div>

          <div>
            <label for="qty">Qty</label>
            <input id="qty" placeholder="Ej: 50 o TODO"
              autocomplete="off" type="text" inputmode="numeric" pattern="[0-9]*" />
          </div>
        </div>

        <div class="btnbar">
          <button class="btn-primary" id="btnAdd">+ Agregar</button>
          <button class="btn-secondary" id="btnPaste">Pegar línea</button>
          <button class="btn-secondary" id="btnCopy">Copiar tabla</button>
          <button class="btn-secondary" id="btnXlsx">Descargar Excel</button>
          <button class="btn-danger" id="btnClear">Limpiar todo</button>
        </div>
      </div>

      <!-- MÓVIL OPERADOR -->
      <div class="content operator">
        <div class="grid">
          <div class="big">
            <label for="mCodigo">Código</label>
            <div class="keyRow">
              <div class="keyWrap">
                <input id="mCodigo" placeholder="Código (12760 o TODO)"
                  autocomplete="off" type="text" inputmode="numeric" pattern="[0-9]*" />
              </div>
              <button class="keyBtn" type="button" data-target="mCodigo">ABC</button>
            </div>
          </div>

          <div class="big">
            <label for="mFrom">Posición (From)</label>
            <div class="keyRow">
              <div class="keyWrap">
                <input id="mFrom" list="locList" placeholder="Buscar ubicación…"
                  autocomplete="off" type="text" inputmode="numeric" pattern="[0-9]*" />
              </div>
              <button class="keyBtn" type="button" data-target="mFrom">ABC</button>
            </div>
          </div>

          <div class="big">
            <label for="mTo">Posición (To)</label>
            <div class="keyRow">
              <div class="keyWrap">
                <input id="mTo" list="locList" placeholder="Buscar ubicación…"
                  autocomplete="off" type="text" inputmode="numeric" pattern="[0-9]*" />
              </div>
              <button class="keyBtn" type="button" data-target="mTo">ABC</button>
            </div>
          </div>

          <div class="big">
            <label for="mQty">Qty</label>
            <div class="keyRow">
              <div class="keyWrap">
                <input id="mQty" placeholder="Cantidad o TODO"
                  autocomplete="off" type="text" inputmode="numeric" pattern="[0-9]*" />
              </div>
              <button class="keyBtn" type="button" data-target="mQty">ABC</button>
            </div>
          </div>

          <div class="btnbar">
            <button class="btn-primary span2" id="mAdd">+ Agregar</button>
            <button class="btn-secondary" id="mPaste">Pegar</button>
            <button class="btn-secondary" id="mCopy">Copiar</button>
            <button class="btn-secondary" id="mXlsx">Excel</button>
            <button class="btn-danger span2" id="mClear">Limpiar todo</button>
          </div>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:16px">
      <h2>Tabla | Movimientos generados</h2>

      <div class="twrap">
        <table>
          <colgroup>
            <col style="width:140px">
            <col style="width:38%">
            <col style="width:38%">
            <col style="width:90px">
            <col style="width:170px">
            <col style="width:120px">
          </colgroup>
          <thead>
            <tr>
              <th>Código</th>
              <th>From</th>
              <th>To</th>
              <th class="right">Qty</th>
              <th>Fecha</th>
              <th>Acción</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div class="mobileList" id="mobileList"></div>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
    import {
      getFirestore, collection, addDoc, deleteDoc, getDocs, writeBatch, doc,
      onSnapshot, query, orderBy, serverTimestamp
    } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyA1_yGJ2Z3jFZYzY5ZeQC1rlh1PFN5M_FU",
      authDomain: "perchado-d3e5b.firebaseapp.com",
      projectId: "perchado-d3e5b",
      storageBucket: "perchado-d3e5b.firebasestorage.app",
      messagingSenderId: "117418842657",
      appId: "1:117418842657:web:8da093b7d020884deb6160"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const COL = "perchar_movimientos";

    const $ = (id) => document.getElementById(id);
    const pad = (n) => String(n).padStart(2,"0");
    const esc = (s) => String(s ?? "")
      .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
      .replaceAll('"',"&quot;").replaceAll("'","&#039;");

    function fmtDate(ts){
      try{
        if (!ts) return "";
        if (typeof ts.toDate === "function"){
          const d = ts.toDate();
          return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
        }
        return String(ts);
      }catch{ return ""; }
    }

    function buildCatalog(){
      const dl = $("locList");
      dl.innerHTML = "";
      const frag = document.createDocumentFragment();

      for(let i=1;i<=90;i++){
        const mid = pad(i);
        for(let j=1;j<=7;j++){
          const opt = document.createElement("option");
          opt.value = `01-30-${mid}-${pad(j)}`;
          frag.appendChild(opt);
        }
      }
      ["Bulk_CW1","Bulk_CW2","Bulk_CW3","Bulk_CW4","Bulk_CW5","Bulk_CW6","Inb_PL-CW","Papeleria","Compra Local"]
        .forEach(v=>{
          const opt = document.createElement("option");
          opt.value = v;
          frag.appendChild(opt);
        });

      dl.appendChild(frag);
    }

    let ROWS = [];

    function setStatus(ok, msg){
      const el = $("syncStatus");
      el.textContent = msg;
      el.classList.remove("ok","bad");
      el.classList.add(ok ? "ok" : "bad");
    }

    function renderDesktop(rows){
      const tb = $("tbody");
      tb.innerHTML = "";
      for(const r of rows){
        const fecha = fmtDate(r.createdAt || r.fecha || "");
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td title="${esc(r.codigo)}">${esc(r.codigo)}</td>
          <td title="${esc(r.from)}">${esc(r.from)}</td>
          <td title="${esc(r.to)}">${esc(r.to)}</td>
          <td class="right" title="${esc(r.qty)}">${esc(r.qty)}</td>
          <td title="${esc(fecha)}">${esc(fecha)}</td>
          <td><button class="btn-del" data-id="${r.id}">Eliminar</button></td>
        `;
        tb.appendChild(tr);
      }
      tb.querySelectorAll("button[data-id]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const id = btn.getAttribute("data-id");
          await deleteDoc(doc(db, COL, id));
        });
      });
    }

    function renderMobile(rows){
      const box = $("mobileList");
      box.innerHTML = "";
      for(const r of rows){
        const fecha = fmtDate(r.createdAt || r.fecha || "");
        const item = document.createElement("div");
        item.className = "mItem";
        item.innerHTML = `
          <div class="mTop">
            <div>${esc(r.codigo)} <span style="color:var(--muted);font-weight:800">• Qty ${esc(r.qty)}</span></div>
            <div style="color:var(--muted);font-size:12px;font-weight:800">${esc(fecha)}</div>
          </div>
          <div class="mMeta">
            <div><b style="color:var(--ink)">From</b><br>${esc(r.from)}</div>
            <div><b style="color:var(--ink)">To</b><br>${esc(r.to)}</div>
          </div>
          <div class="mActions">
            <button class="btn-del" data-id="${r.id}">Eliminar</button>
          </div>
        `;
        box.appendChild(item);
      }
      box.querySelectorAll("button[data-id]").forEach(btn=>{
        btn.addEventListener("click", async ()=>{
          const id = btn.getAttribute("data-id");
          await deleteDoc(doc(db, COL, id));
        });
      });
    }

    function renderAll(rows){
      $("countTag").textContent = `${rows.length} registros`;
      renderDesktop(rows);
      renderMobile(rows);
    }

    // Qty: acepta número (>0) o texto (TODO). No puede ir vacío.
    function validateQty(qtyRaw){
      const s = String(qtyRaw ?? "").trim();
      if(!s) return { ok:false, msg:"Qty vacío." };

      if (/^\d+(\.\d+)?$/.test(s)){
        const n = Number(s);
        if (!Number.isFinite(n) || n <= 0) return { ok:false, msg:"Qty numérico debe ser > 0." };
        return { ok:true, value:n };
      }
      return { ok:true, value:s };
    }

    async function addMovement({codigo, from, to, qty}){
      const c = String(codigo ?? "").trim();
      const f = String(from ?? "").trim();
      const t = String(to ?? "").trim();
      if(!c) return alert("Falta el Código.");
      if(!f) return alert("Falta From.");
      if(!t) return alert("Falta To.");

      const vq = validateQty(qty);
      if(!vq.ok) return alert(vq.msg);

      await addDoc(collection(db, COL), {
        codigo: c,
        from: f,
        to: t,
        qty: vq.value,
        createdAt: serverTimestamp()
      });
    }

    function readDesktopInputs(){
      return { codigo: $("codigo").value, from: $("posFrom").value, to: $("posTo").value, qty: $("qty").value };
    }
    function clearDesktopInputs(){
      $("codigo").value=""; $("posFrom").value=""; $("posTo").value=""; $("qty").value="";
      $("codigo").focus();
    }

    function readMobileInputs(){
      return { codigo: $("mCodigo").value, from: $("mFrom").value, to: $("mTo").value, qty: $("mQty").value };
    }
    function clearMobileInputs(){
      $("mCodigo").value=""; $("mFrom").value=""; $("mTo").value=""; $("mQty").value="";
      $("mCodigo").focus();
    }

    async function pasteLineInto(which){
      const raw = prompt("Pega: codigo  from  to  qty (qty puede ser TODO)");
      if(!raw) return;
      const parts = raw.trim().split(/\s+|\t+|\s*,\s*/).filter(Boolean);
      if(parts.length < 4) return alert("Formato inválido. Ej: 12760 01-30-088-02 01-30-088-03 50 (o TODO)");

      const qtyVal = parts.slice(3).join(" ");

      if(which === "mobile"){
        $("mCodigo").value = parts[0];
        $("mFrom").value   = parts[1];
        $("mTo").value     = parts[2];
        $("mQty").value    = qtyVal;
        await addMovement(readMobileInputs());
        clearMobileInputs();
      }else{
        $("codigo").value  = parts[0];
        $("posFrom").value = parts[1];
        $("posTo").value   = parts[2];
        $("qty").value     = qtyVal;
        await addMovement(readDesktopInputs());
        clearDesktopInputs();
      }
    }

    async function copyTable(){
      if(!ROWS.length) return alert("No hay registros para copiar.");
      const header = ["codigo","posicion(from)","posicion(to)","qty"].join("\t");
      const lines = ROWS.slice().reverse().map(r => [r.codigo, r.from, r.to, r.qty].join("\t"));
      const text = [header, ...lines].join("\n");
      try{ await navigator.clipboard.writeText(text); alert("Copiado. Pega directo en Excel."); }
      catch{
        const ta=document.createElement("textarea"); ta.value=text; document.body.appendChild(ta);
        ta.select(); document.execCommand("copy"); ta.remove();
        alert("Copiado. Pega directo en Excel.");
      }
    }

    function exportXlsx(){
      if(!ROWS.length) return alert("No hay registros para exportar.");
      const data = ROWS.slice().reverse().map(r => ({
        codigo: r.codigo,
        "posicion(from)": r.from,
        "posicion(to)": r.to,
        qty: r.qty,
        fecha: fmtDate(r.createdAt || r.fecha || "")
      }));
      const ws = XLSX.utils.json_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Movimientos");
      XLSX.writeFile(wb, `Perchar_Movimientos_${new Date().toISOString().slice(0,10)}.xlsx`);
    }

    async function clearAll(){
      const ok = confirm("¿Borrar TODO lo guardado en la nube (Firebase)?");
      if(!ok) return;
      const snap = await getDocs(collection(db, COL));
      if(snap.empty) return setStatus(true,"No había registros");

      let batch = writeBatch(db);
      let count = 0;
      for(const d of snap.docs){
        batch.delete(d.ref);
        count++;
        if(count % 450 === 0){
          await batch.commit();
          batch = writeBatch(db);
        }
      }
      await batch.commit();
      setStatus(true,"Todo limpio");
    }

    // Eventos Desktop
    $("btnAdd").addEventListener("click", async ()=>{ await addMovement(readDesktopInputs()); clearDesktopInputs(); });
    $("btnPaste").addEventListener("click", ()=>pasteLineInto("desktop"));
    $("btnCopy").addEventListener("click", copyTable);
    $("btnXlsx").addEventListener("click", exportXlsx);
    $("btnClear").addEventListener("click", clearAll);
    ["codigo","posFrom","posTo","qty"].forEach(id=>{
      $(id).addEventListener("keydown", async (e)=>{
        if(e.key==="Enter"){ await addMovement(readDesktopInputs()); clearDesktopInputs(); }
      });
    });

    // Eventos Mobile
    $("mAdd").addEventListener("click", async ()=>{ await addMovement(readMobileInputs()); clearMobileInputs(); });
    $("mPaste").addEventListener("click", ()=>pasteLineInto("mobile"));
    $("mCopy").addEventListener("click", copyTable);
    $("mXlsx").addEventListener("click", exportXlsx);
    $("mClear").addEventListener("click", clearAll);
    ["mCodigo","mFrom","mTo","mQty"].forEach(id=>{
      $(id).addEventListener("keydown", async (e)=>{
        if(e.key==="Enter"){ await addMovement(readMobileInputs()); clearMobileInputs(); }
      });
    });

    // ✅ Toggle ABC/NUM en móvil
    function enableKeyboardToggles(){
      const btns = document.querySelectorAll(".keyBtn[data-target]");
      btns.forEach(btn=>{
        btn.addEventListener("click", ()=>{
          const id = btn.getAttribute("data-target");
          const el = document.getElementById(id);
          if(!el) return;

          const isABC = btn.classList.contains("active");

          if(isABC){
            btn.classList.remove("active");
            el.setAttribute("inputmode","numeric");
            el.setAttribute("pattern","[0-9]*");
          }else{
            btn.classList.add("active");
            el.setAttribute("inputmode","text");
            el.removeAttribute("pattern");
          }

          el.blur();
          setTimeout(()=>el.focus(), 50);
        });
      });
    }

    buildCatalog();
    enableKeyboardToggles();

    // Listener realtime
    try{
      const q = query(collection(db, COL), orderBy("createdAt","desc"));
      onSnapshot(q, (snap)=>{
        ROWS = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderAll(ROWS);
        setStatus(true,"Sincronizado");
      }, (err)=>{
        console.error(err);
        setStatus(false,"Sin permiso / Rules");
      });
    }catch(e){
      console.error(e);
      setStatus(false,"Error Firebase");
    }
  </script>
</body>
</html>
